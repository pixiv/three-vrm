/*! (c) 2019-2024 pixiv Inc. - https://github.com/pixiv/three-vrm/blob/release/LICENSE */
var U=(l,e,t)=>new Promise((r,i)=>{var o=s=>{try{a(t.next(s))}catch(d){i(d)}},n=s=>{try{a(t.throw(s))}catch(d){i(d)}},a=s=>s.done?r(s.value):Promise.resolve(s.value).then(o,n);a((t=t.apply(l,e)).next())});import*as y from"three";import*as Y from"three";var O=class{};var nt=new Y.Vector3,V=new Y.Vector3,L=class extends O{get type(){return"capsule"}constructor(e){var t,r,i;super(),this.offset=(t=e==null?void 0:e.offset)!=null?t:new Y.Vector3(0,0,0),this.tail=(r=e==null?void 0:e.tail)!=null?r:new Y.Vector3(0,0,0),this.radius=(i=e==null?void 0:e.radius)!=null?i:0}calculateCollision(e,t,r,i){nt.copy(this.offset).applyMatrix4(e),V.copy(this.tail).applyMatrix4(e),V.sub(nt);let o=V.lengthSq();i.copy(t).sub(nt);let n=V.dot(i);n<=0||(o<=n||V.multiplyScalar(n/o),i.sub(V));let a=r+this.radius,s=i.length()-a;return i.normalize(),s}};import*as lt from"three";var D=class extends O{get type(){return"sphere"}constructor(e){var t,r;super(),this.offset=(t=e==null?void 0:e.offset)!=null?t:new lt.Vector3(0,0,0),this.radius=(r=e==null?void 0:e.radius)!=null?r:0}calculateCollision(e,t,r,i){i.copy(this.offset).applyMatrix4(e),i.negate().add(t);let o=r+this.radius,n=i.length()-o;return i.normalize(),n}};import*as b from"three";var T=new b.Vector3,K=class extends b.BufferGeometry{constructor(t){super();this.worldScale=1;this._currentRadius=0;this._currentOffset=new b.Vector3;this._currentTail=new b.Vector3;this._shape=t,this._attrPos=new b.BufferAttribute(new Float32Array(396),3),this.setAttribute("position",this._attrPos),this._attrIndex=new b.BufferAttribute(new Uint16Array(264),1),this.setIndex(this._attrIndex),this._buildIndex(),this.update()}update(){let t=!1,r=this._shape.radius/this.worldScale;this._currentRadius!==r&&(this._currentRadius=r,t=!0),this._currentOffset.equals(this._shape.offset)||(this._currentOffset.copy(this._shape.offset),t=!0);let i=T.copy(this._shape.tail).divideScalar(this.worldScale);this._currentTail.distanceToSquared(i)>1e-10&&(this._currentTail.copy(i),t=!0),t&&this._buildPosition()}_buildPosition(){T.copy(this._currentTail).sub(this._currentOffset);let t=T.length()/this._currentRadius;for(let o=0;o<=16;o++){let n=o/16*Math.PI;this._attrPos.setXYZ(o,-Math.sin(n),-Math.cos(n),0),this._attrPos.setXYZ(17+o,t+Math.sin(n),Math.cos(n),0),this._attrPos.setXYZ(34+o,-Math.sin(n),0,-Math.cos(n)),this._attrPos.setXYZ(51+o,t+Math.sin(n),0,Math.cos(n))}for(let o=0;o<32;o++){let n=o/16*Math.PI;this._attrPos.setXYZ(68+o,0,Math.sin(n),Math.cos(n)),this._attrPos.setXYZ(100+o,t,Math.sin(n),Math.cos(n))}let r=Math.atan2(T.y,Math.sqrt(T.x*T.x+T.z*T.z)),i=-Math.atan2(T.z,T.x);this.rotateZ(r),this.rotateY(i),this.scale(this._currentRadius,this._currentRadius,this._currentRadius),this.translate(this._currentOffset.x,this._currentOffset.y,this._currentOffset.z),this._attrPos.needsUpdate=!0}_buildIndex(){for(let t=0;t<34;t++){let r=(t+1)%34;this._attrIndex.setXY(t*2,t,r),this._attrIndex.setXY(68+t*2,34+t,34+r)}for(let t=0;t<32;t++){let r=(t+1)%32;this._attrIndex.setXY(136+t*2,68+t,68+r),this._attrIndex.setXY(200+t*2,100+t,100+r)}this._attrIndex.needsUpdate=!0}};import*as B from"three";var tt=class extends B.BufferGeometry{constructor(t){super();this.worldScale=1;this._currentRadius=0;this._currentOffset=new B.Vector3;this._shape=t,this._attrPos=new B.BufferAttribute(new Float32Array(32*3*3),3),this.setAttribute("position",this._attrPos),this._attrIndex=new B.BufferAttribute(new Uint16Array(64*3),1),this.setIndex(this._attrIndex),this._buildIndex(),this.update()}update(){let t=!1,r=this._shape.radius/this.worldScale;this._currentRadius!==r&&(this._currentRadius=r,t=!0),this._currentOffset.equals(this._shape.offset)||(this._currentOffset.copy(this._shape.offset),t=!0),t&&this._buildPosition()}_buildPosition(){for(let t=0;t<32;t++){let r=t/16*Math.PI;this._attrPos.setXYZ(t,Math.cos(r),Math.sin(r),0),this._attrPos.setXYZ(32+t,0,Math.cos(r),Math.sin(r)),this._attrPos.setXYZ(64+t,Math.sin(r),0,Math.cos(r))}this.scale(this._currentRadius,this._currentRadius,this._currentRadius),this.translate(this._currentOffset.x,this._currentOffset.y,this._currentOffset.z),this._attrPos.needsUpdate=!0}_buildIndex(){for(let t=0;t<32;t++){let r=(t+1)%32;this._attrIndex.setXY(t*2,t,r),this._attrIndex.setXY(64+t*2,32+t,32+r),this._attrIndex.setXY(128+t*2,64+t,64+r)}this._attrIndex.needsUpdate=!0}};var Rt=new y.Vector3,J=class extends y.Group{constructor(e){if(super(),this.matrixAutoUpdate=!1,this.collider=e,this.collider.shape instanceof D)this._geometry=new tt(this.collider.shape);else if(this.collider.shape instanceof L)this._geometry=new K(this.collider.shape);else throw new Error("VRMSpringBoneColliderHelper: Unknown collider shape type detected");let t=new y.LineBasicMaterial({color:16711935,depthTest:!1,depthWrite:!1});this._line=new y.LineSegments(this._geometry,t),this.add(this._line)}dispose(){this._geometry.dispose()}updateMatrixWorld(e){this.collider.updateWorldMatrix(!0,!1),this.matrix.copy(this.collider.matrixWorld);let t=this.matrix.elements;this._geometry.worldScale=Rt.set(t[0],t[1],t[2]).length(),this._geometry.update(),super.updateMatrixWorld(e)}};import*as v from"three";import*as w from"three";var et=class extends w.BufferGeometry{constructor(t){super();this.worldScale=1;this._currentRadius=0;this._currentTail=new w.Vector3;this._springBone=t,this._attrPos=new w.BufferAttribute(new Float32Array(294),3),this.setAttribute("position",this._attrPos),this._attrIndex=new w.BufferAttribute(new Uint16Array(194),1),this.setIndex(this._attrIndex),this._buildIndex(),this.update()}update(){let t=!1,r=this._springBone.settings.hitRadius/this.worldScale;this._currentRadius!==r&&(this._currentRadius=r,t=!0),this._currentTail.equals(this._springBone.initialLocalChildPosition)||(this._currentTail.copy(this._springBone.initialLocalChildPosition),t=!0),t&&this._buildPosition()}_buildPosition(){for(let t=0;t<32;t++){let r=t/16*Math.PI;this._attrPos.setXYZ(t,Math.cos(r),Math.sin(r),0),this._attrPos.setXYZ(32+t,0,Math.cos(r),Math.sin(r)),this._attrPos.setXYZ(64+t,Math.sin(r),0,Math.cos(r))}this.scale(this._currentRadius,this._currentRadius,this._currentRadius),this.translate(this._currentTail.x,this._currentTail.y,this._currentTail.z),this._attrPos.setXYZ(96,0,0,0),this._attrPos.setXYZ(97,this._currentTail.x,this._currentTail.y,this._currentTail.z),this._attrPos.needsUpdate=!0}_buildIndex(){for(let t=0;t<32;t++){let r=(t+1)%32;this._attrIndex.setXY(t*2,t,r),this._attrIndex.setXY(64+t*2,32+t,32+r),this._attrIndex.setXY(128+t*2,64+t,64+r)}this._attrIndex.setXY(192,96,97),this._attrIndex.needsUpdate=!0}};var _t=new v.Vector3,z=class extends v.Group{constructor(e){super(),this.matrixAutoUpdate=!1,this.springBone=e,this._geometry=new et(this.springBone);let t=new v.LineBasicMaterial({color:16776960,depthTest:!1,depthWrite:!1});this._line=new v.LineSegments(this._geometry,t),this.add(this._line)}dispose(){this._geometry.dispose()}updateMatrixWorld(e){this.springBone.bone.updateWorldMatrix(!0,!1),this.matrix.copy(this.springBone.bone.matrixWorld);let t=this.matrix.elements;this._geometry.worldScale=_t.set(t[0],t[1],t[2]).length(),this._geometry.update(),super.updateMatrixWorld(e)}};import*as pt from"three";var N=class extends pt.Object3D{constructor(e){super(),this.shape=e}};import*as c from"three";import*as ct from"three";var mt=new ct.Matrix4;function rt(l){return l.invert?l.invert():l.getInverse(mt.copy(l)),l}import*as dt from"three";var it=class{constructor(e){this._inverseCache=new dt.Matrix4;this._shouldUpdateInverse=!0;this.matrix=e;let t={set:(r,i,o)=>(this._shouldUpdateInverse=!0,r[i]=o,!0)};this._originalElements=e.elements,e.elements=new Proxy(e.elements,t)}get inverse(){return this._shouldUpdateInverse&&(rt(this._inverseCache.copy(this.matrix)),this._shouldUpdateInverse=!1),this._inverseCache}revert(){this.matrix.elements=this._originalElements}};var gt=new c.Matrix4,x=new c.Vector3,Z=new c.Vector3,St=new c.Vector3,A=new c.Vector3,ut=new c.Vector3,q=new c.Vector3,ht=new c.Quaternion,W=new c.Matrix4,Mt=new c.Matrix4,ot=class{constructor(e,t,r={},i=[]){this._currentTail=new c.Vector3;this._prevTail=new c.Vector3;this._boneAxis=new c.Vector3;this._worldSpaceBoneLength=0;this._center=null;this._initialLocalMatrix=new c.Matrix4;this._initialLocalRotation=new c.Quaternion;this._initialLocalChildPosition=new c.Vector3;var o,n,a,s,d,m;this.bone=e,this.bone.matrixAutoUpdate=!1,this.child=t,this.settings={hitRadius:(o=r.hitRadius)!=null?o:0,stiffness:(n=r.stiffness)!=null?n:1,gravityPower:(a=r.gravityPower)!=null?a:0,gravityDir:(d=(s=r.gravityDir)==null?void 0:s.clone())!=null?d:new c.Vector3(0,-1,0),dragForce:(m=r.dragForce)!=null?m:.4},this.colliderGroups=i}get center(){return this._center}set center(e){var t;(t=this._center)!=null&&t.userData.inverseCacheProxy&&(this._center.userData.inverseCacheProxy.revert(),delete this._center.userData.inverseCacheProxy),this._center=e,this._center&&(this._center.userData.inverseCacheProxy||(this._center.userData.inverseCacheProxy=new it(this._center.matrixWorld)))}get initialLocalChildPosition(){return this._initialLocalChildPosition}get _parentMatrixWorld(){return this.bone.parent?this.bone.parent.matrixWorld:gt}setInitState(){this._initialLocalMatrix.copy(this.bone.matrix),this._initialLocalRotation.copy(this.bone.quaternion),this.child?this._initialLocalChildPosition.copy(this.child.position):this._initialLocalChildPosition.copy(this.bone.position).normalize().multiplyScalar(.07);let e=this._getMatrixWorldToCenter(W);this.bone.localToWorld(this._currentTail.copy(this._initialLocalChildPosition)).applyMatrix4(e),this._prevTail.copy(this._currentTail),this._boneAxis.copy(this._initialLocalChildPosition).normalize()}reset(){this.bone.quaternion.copy(this._initialLocalRotation),this.bone.updateMatrix(),this.bone.matrixWorld.multiplyMatrices(this._parentMatrixWorld,this.bone.matrix);let e=this._getMatrixWorldToCenter(W);this.bone.localToWorld(this._currentTail.copy(this._initialLocalChildPosition)).applyMatrix4(e),this._prevTail.copy(this._currentTail)}update(e){if(e<=0)return;this._calcWorldSpaceBoneLength(),A.setFromMatrixPosition(this.bone.matrixWorld);let t=this._getMatrixWorldToCenter(W);ut.copy(A).applyMatrix4(t);let r=ht.setFromRotationMatrix(t),i=Mt.copy(t).multiply(this._parentMatrixWorld),o=Z.copy(this._boneAxis).applyMatrix4(this._initialLocalMatrix).applyMatrix4(i).sub(ut).normalize(),n=St.copy(this.settings.gravityDir).applyQuaternion(r).normalize(),a=this._getMatrixCenterToWorld(W);q.copy(this._currentTail).add(x.copy(this._currentTail).sub(this._prevTail).multiplyScalar(1-this.settings.dragForce)).add(x.copy(o).multiplyScalar(this.settings.stiffness*e)).add(x.copy(n).multiplyScalar(this.settings.gravityPower*e)).applyMatrix4(a),q.sub(A).normalize().multiplyScalar(this._worldSpaceBoneLength).add(A),this._collision(q),t=this._getMatrixWorldToCenter(W),this._prevTail.copy(this._currentTail),this._currentTail.copy(x.copy(q).applyMatrix4(t));let s=rt(W.copy(this._parentMatrixWorld).multiply(this._initialLocalMatrix)),d=ht.setFromUnitVectors(this._boneAxis,x.copy(q).applyMatrix4(s).normalize());this.bone.quaternion.copy(this._initialLocalRotation).multiply(d),this.bone.updateMatrix(),this.bone.matrixWorld.multiplyMatrices(this._parentMatrixWorld,this.bone.matrix)}_collision(e){this.colliderGroups.forEach(t=>{t.colliders.forEach(r=>{let i=r.shape.calculateCollision(r.matrixWorld,e,this.settings.hitRadius,x);i<0&&(e.add(x.multiplyScalar(-i)),e.sub(A).normalize().multiplyScalar(this._worldSpaceBoneLength).add(A))})})}_calcWorldSpaceBoneLength(){x.setFromMatrixPosition(this.bone.matrixWorld),this.child?Z.setFromMatrixPosition(this.child.matrixWorld):(Z.copy(this._initialLocalChildPosition),Z.applyMatrix4(this.bone.matrixWorld)),this._worldSpaceBoneLength=x.sub(Z).length()}_getMatrixCenterToWorld(e){return this._center?e.copy(this._center.matrixWorld):e.identity(),e}_getMatrixWorldToCenter(e){return this._center?e.copy(this._center.userData.inverseCacheProxy.inverse):e.identity(),e}};import*as C from"three";function ft(l,e){let t=[],r=l;for(;r!==null;)t.unshift(r),r=r.parent;t.forEach(i=>{e(i)})}function st(l,e){l.children.forEach(t=>{e(t)||st(t,e)})}var $=class{constructor(){this._joints=new Set;this._objectSpringBonesMap=new Map}get joints(){return this._joints}get springBones(){return console.warn("VRMSpringBoneManager: springBones is deprecated. use joints instead."),this._joints}get colliderGroups(){let e=new Set;return this._joints.forEach(t=>{t.colliderGroups.forEach(r=>{e.add(r)})}),Array.from(e)}get colliders(){let e=new Set;return this.colliderGroups.forEach(t=>{t.colliders.forEach(r=>{e.add(r)})}),Array.from(e)}addJoint(e){this._joints.add(e);let t=this._objectSpringBonesMap.get(e.bone);t==null&&(t=new Set,this._objectSpringBonesMap.set(e.bone,t)),t.add(e)}addSpringBone(e){console.warn("VRMSpringBoneManager: addSpringBone() is deprecated. use addJoint() instead."),this.addJoint(e)}deleteJoint(e){this._joints.delete(e),this._objectSpringBonesMap.get(e.bone).delete(e)}deleteSpringBone(e){console.warn("VRMSpringBoneManager: deleteSpringBone() is deprecated. use deleteJoint() instead."),this.deleteJoint(e)}setInitState(){let e=new Set,t=new Set,r=new Set;for(let i of this._joints)this._processSpringBone(i,e,t,r,o=>o.setInitState())}reset(){let e=new Set,t=new Set,r=new Set;for(let i of this._joints)this._processSpringBone(i,e,t,r,o=>o.reset())}update(e){let t=new Set,r=new Set,i=new Set;for(let o of this._joints)this._processSpringBone(o,t,r,i,n=>n.update(e)),st(o.bone,n=>{var a,s;return((s=(a=this._objectSpringBonesMap.get(n))==null?void 0:a.size)!=null?s:0)>0?!0:(n.updateWorldMatrix(!1,!1),!1)})}_processSpringBone(e,t,r,i,o){if(r.has(e))return;if(t.has(e))throw new Error("VRMSpringBoneManager: Circular dependency detected while updating springbones");t.add(e);let n=this._getDependencies(e);for(let a of n)ft(a,s=>{let d=this._objectSpringBonesMap.get(s);if(d)for(let m of d)this._processSpringBone(m,t,r,i,o);else i.has(s)||(s.updateWorldMatrix(!1,!1),i.add(s))});e.bone.updateMatrix(),e.bone.updateWorldMatrix(!1,!1),o(e),i.add(e.bone),r.add(e)}_getDependencies(e){let t=new Set,r=e.bone.parent;return r&&t.add(r),e.colliderGroups.forEach(i=>{i.colliders.forEach(o=>{t.add(o)})}),t}};var Tt=new Set(["1.0","1.0-beta"]),P=class P{get name(){return P.EXTENSION_NAME}constructor(e,t){this.parser=e,this.jointHelperRoot=t==null?void 0:t.jointHelperRoot,this.colliderHelperRoot=t==null?void 0:t.colliderHelperRoot}afterRoot(e){return U(this,null,function*(){e.userData.vrmSpringBoneManager=yield this._import(e)})}_import(e){return U(this,null,function*(){let t=yield this._v1Import(e);if(t!=null)return t;let r=yield this._v0Import(e);return r!=null?r:null})}_v1Import(e){return U(this,null,function*(){var m,G,F,u,I;let t=e.parser.json;if(!(((m=t.extensionsUsed)==null?void 0:m.indexOf(P.EXTENSION_NAME))!==-1))return null;let i=new $,o=yield e.parser.getDependencies("node"),n=(G=t.extensions)==null?void 0:G[P.EXTENSION_NAME];if(!n)return null;let a=n.specVersion;if(!Tt.has(a))return console.warn(`VRMSpringBoneLoaderPlugin: Unknown ${P.EXTENSION_NAME} specVersion "${a}"`),null;let s=(F=n.colliders)==null?void 0:F.map((f,g)=>{var R,p,S,_,M;let E=o[f.node],h=f.shape;if(h.sphere)return this._importSphereCollider(E,{offset:new C.Vector3().fromArray((R=h.sphere.offset)!=null?R:[0,0,0]),radius:(p=h.sphere.radius)!=null?p:0});if(h.capsule)return this._importCapsuleCollider(E,{offset:new C.Vector3().fromArray((S=h.capsule.offset)!=null?S:[0,0,0]),radius:(_=h.capsule.radius)!=null?_:0,tail:new C.Vector3().fromArray((M=h.capsule.tail)!=null?M:[0,0,0])});throw new Error(`VRMSpringBoneLoaderPlugin: The collider #${g} has no valid shape`)}),d=(u=n.colliderGroups)==null?void 0:u.map((f,g)=>{var h;return{colliders:((h=f.colliders)!=null?h:[]).map(R=>{let p=s==null?void 0:s[R];if(p==null)throw new Error(`VRMSpringBoneLoaderPlugin: The colliderGroup #${g} attempted to use a collider #${R} but not found`);return p}),name:f.name}});return(I=n.springs)==null||I.forEach((f,g)=>{var S;let E=f.joints,h=(S=f.colliderGroups)==null?void 0:S.map(_=>{let M=d==null?void 0:d[_];if(M==null)throw new Error(`VRMSpringBoneLoaderPlugin: The spring #${g} attempted to use a colliderGroup ${_} but not found`);return M}),R=f.center!=null?o[f.center]:void 0,p;E.forEach(_=>{if(p){let M=p.node,Q=o[M],k=_.node,H=o[k],j={hitRadius:p.hitRadius,dragForce:p.dragForce,gravityPower:p.gravityPower,stiffness:p.stiffness,gravityDir:p.gravityDir!=null?new C.Vector3().fromArray(p.gravityDir):void 0},X=this._importJoint(Q,H,j,h);R&&(X.center=R),i.addJoint(X)}p=_})}),i.setInitState(),i})}_v0Import(e){return U(this,null,function*(){var m,G,F;let t=e.parser.json;if(!(((m=t.extensionsUsed)==null?void 0:m.indexOf("VRM"))!==-1))return null;let i=(G=t.extensions)==null?void 0:G.VRM,o=i==null?void 0:i.secondaryAnimation;if(!o)return null;let n=o==null?void 0:o.boneGroups;if(!n)return null;let a=new $,s=yield e.parser.getDependencies("node"),d=(F=o.colliderGroups)==null?void 0:F.map(u=>{var g;let I=s[u.node];return{colliders:((g=u.colliders)!=null?g:[]).map((E,h)=>{var p,S,_;let R=new C.Vector3(0,0,0);return E.offset&&R.set((p=E.offset.x)!=null?p:0,(S=E.offset.y)!=null?S:0,E.offset.z?-E.offset.z:0),this._importSphereCollider(I,{offset:R,radius:(_=E.radius)!=null?_:0})})}});return n==null||n.forEach((u,I)=>{let f=u.bones;f&&f.forEach(g=>{var _,M,Q,k;let E=s[g],h=new C.Vector3;u.gravityDir?h.set((_=u.gravityDir.x)!=null?_:0,(M=u.gravityDir.y)!=null?M:0,(Q=u.gravityDir.z)!=null?Q:0):h.set(0,-1,0);let R=u.center!=null?s[u.center]:void 0,p={hitRadius:u.hitRadius,dragForce:u.dragForce,gravityPower:u.gravityPower,stiffness:u.stiffiness,gravityDir:h},S=(k=u.colliderGroups)==null?void 0:k.map(H=>{let j=d==null?void 0:d[H];if(j==null)throw new Error(`VRMSpringBoneLoaderPlugin: The spring #${I} attempted to use a colliderGroup ${H} but not found`);return j});E.traverse(H=>{var at;let j=(at=H.children[0])!=null?at:null,X=this._importJoint(H,j,p,S);R&&(X.center=R),a.addJoint(X)})})}),e.scene.updateMatrixWorld(),a.setInitState(),a})}_importJoint(e,t,r,i){let o=new ot(e,t,r,i);if(this.jointHelperRoot){let n=new z(o);this.jointHelperRoot.add(n),n.renderOrder=this.jointHelperRoot.renderOrder}return o}_importSphereCollider(e,t){let{offset:r,radius:i}=t,o=new D({offset:r,radius:i}),n=new N(o);if(e.add(n),this.colliderHelperRoot){let a=new J(n);this.colliderHelperRoot.add(a),a.renderOrder=this.colliderHelperRoot.renderOrder}return n}_importCapsuleCollider(e,t){let{offset:r,radius:i,tail:o}=t,n=new L({offset:r,radius:i,tail:o}),a=new N(n);if(e.add(a),this.colliderHelperRoot){let s=new J(a);this.colliderHelperRoot.add(s),s.renderOrder=this.colliderHelperRoot.renderOrder}return a}};P.EXTENSION_NAME="VRMC_springBone";var Et=P;export{N as VRMSpringBoneCollider,J as VRMSpringBoneColliderHelper,O as VRMSpringBoneColliderShape,L as VRMSpringBoneColliderShapeCapsule,D as VRMSpringBoneColliderShapeSphere,ot as VRMSpringBoneJoint,z as VRMSpringBoneJointHelper,Et as VRMSpringBoneLoaderPlugin,$ as VRMSpringBoneManager};
