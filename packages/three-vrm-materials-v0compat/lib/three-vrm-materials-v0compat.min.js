/*! (c) 2020-2023 pixiv Inc. - https://github.com/pixiv/three-vrm/blob/release/LICENSE */
!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).THREE_VRM_MATERIALS_V0COMPAT={},e.THREE)}(this,(function(e,o){"use strict";function t(e){if(e&&e.__esModule)return e;var o=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(o,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})}})),o.default=e,Object.freeze(o)}var i=t(o);function r(e,o,t,i){return new(t||(t=Promise))((function(r,n){function l(e){try{a(i.next(e))}catch(e){n(e)}}function s(e){try{a(i.throw(e))}catch(e){n(e)}}function a(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(l,s)}a((i=i.apply(e,o||[])).next())}))}function n(e){return Math.pow(e,2.2)}e.VRMMaterialsV0CompatPlugin=class{get name(){return"VRMMaterialsV0CompatPlugin"}constructor(e){var o;this.parser=e,this._renderQueueMapTransparent=new Map,this._renderQueueMapTransparentZWrite=new Map;const t=this.parser.json;t.extensionsUsed=null!==(o=t.extensionsUsed)&&void 0!==o?o:[],-1===t.extensionsUsed.indexOf("KHR_texture_transform")&&t.extensionsUsed.push("KHR_texture_transform")}beforeRoot(){var e;return r(this,void 0,void 0,(function*(){const o=this.parser.json,t=null===(e=o.extensions)||void 0===e?void 0:e.VRM,i=null==t?void 0:t.materialProperties;i&&(this._populateRenderQueueMap(i),i.forEach(((e,t)=>{var i,r;const n=null===(i=o.materials)||void 0===i?void 0:i[t];if(null!=n)if("VRM/MToon"===e.shader){const i=this._parseV0MToonProperties(e,n);o.materials[t]=i}else if(null===(r=e.shader)||void 0===r?void 0:r.startsWith("VRM/Unlit")){const i=this._parseV0UnlitProperties(e,n);o.materials[t]=i}else"VRM_USE_GLTFSHADER"===e.shader||console.warn(`VRMMaterialsV0CompatPlugin: Unknown shader: ${e.shader}`);else console.warn(`VRMMaterialsV0CompatPlugin: Attempt to use materials[${t}] of glTF but the material doesn't exist`)})))}))}_parseV0MToonProperties(e,o){var t,r,l,s,a,u,d,v,p,c,f,h,_,m,M,x,P,T,R,g,b,O,V,C,y,A,S,w,E,F,j,U,W,L,Q,N,H,Z,k,z,B,D,q,K;const $=null!==(r=null===(t=e.keywordMap)||void 0===t?void 0:t._ALPHABLEND_ON)&&void 0!==r&&r,I=1===(null===(l=e.floatProperties)||void 0===l?void 0:l._ZWrite)&&$,X=this._v0ParseRenderQueue(e),Y=null!==(a=null===(s=e.keywordMap)||void 0===s?void 0:s._ALPHATEST_ON)&&void 0!==a&&a,G=$?"BLEND":Y?"MASK":"OPAQUE",J=Y?null===(u=e.floatProperties)||void 0===u?void 0:u._Cutoff:void 0,ee=0===(null!==(v=null===(d=e.floatProperties)||void 0===d?void 0:d._CullMode)&&void 0!==v?v:2),oe=this._portTextureTransform(e),te=null===(c=null===(p=e.vectorProperties)||void 0===p?void 0:p._Color)||void 0===c?void 0:c.map(((e,o)=>3===o?e:n(e))),ie=null===(f=e.textureProperties)||void 0===f?void 0:f._MainTex,re=null!=ie?{index:ie,extensions:Object.assign({},oe)}:void 0,ne=null===(h=e.floatProperties)||void 0===h?void 0:h._BumpScale,le=null===(_=e.textureProperties)||void 0===_?void 0:_._BumpMap,se=null!=le?{index:le,scale:ne,extensions:Object.assign({},oe)}:void 0,ae=null===(M=null===(m=e.vectorProperties)||void 0===m?void 0:m._EmissionColor)||void 0===M?void 0:M.map(n),ue=null===(x=e.textureProperties)||void 0===x?void 0:x._EmissionMap,de=null!=ue?{index:ue,extensions:Object.assign({},oe)}:void 0,ve=null===(T=null===(P=e.vectorProperties)||void 0===P?void 0:P._ShadeColor)||void 0===T?void 0:T.map(n),pe=null===(R=e.textureProperties)||void 0===R?void 0:R._ShadeTexture,ce=null!=pe?{index:pe,extensions:Object.assign({},oe)}:void 0;let fe=null!==(b=null===(g=e.floatProperties)||void 0===g?void 0:g._ShadeShift)&&void 0!==b?b:0,he=null!==(V=null===(O=e.floatProperties)||void 0===O?void 0:O._ShadeToony)&&void 0!==V?V:.9;he=i.MathUtils.lerp(he,1,.5+.5*fe),fe=-fe-(1-he);const _e=null===(C=e.floatProperties)||void 0===C?void 0:C._IndirectLightIntensity,me=_e?1-_e:void 0,Me=null===(y=e.textureProperties)||void 0===y?void 0:y._SphereAdd,xe=null!=Me?[1,1,1]:void 0,Pe=null!=Me?{index:Me}:void 0,Te=null===(A=e.floatProperties)||void 0===A?void 0:A._RimLightingMix,Re=null===(S=e.textureProperties)||void 0===S?void 0:S._RimTexture,ge=null!=Re?{index:Re,extensions:Object.assign({},oe)}:void 0,be=null===(E=null===(w=e.vectorProperties)||void 0===w?void 0:w._RimColor)||void 0===E?void 0:E.map(n),Oe=null===(F=e.floatProperties)||void 0===F?void 0:F._RimFresnelPower,Ve=null===(j=e.floatProperties)||void 0===j?void 0:j._RimLift,Ce=["none","worldCoordinates","screenCoordinates"][null!==(W=null===(U=e.floatProperties)||void 0===U?void 0:U._OutlineWidthMode)&&void 0!==W?W:0];let ye=null!==(Q=null===(L=e.floatProperties)||void 0===L?void 0:L._OutlineWidth)&&void 0!==Q?Q:0;ye*=.01;const Ae=null===(N=e.textureProperties)||void 0===N?void 0:N._OutlineWidthTexture,Se=null!=Ae?{index:Ae,extensions:Object.assign({},oe)}:void 0,we=null===(Z=null===(H=e.vectorProperties)||void 0===H?void 0:H._OutlineColor)||void 0===Z?void 0:Z.map(n),Ee=1===(null===(k=e.floatProperties)||void 0===k?void 0:k._OutlineColorMode)?null===(z=e.floatProperties)||void 0===z?void 0:z._OutlineLightingMix:0,Fe=null===(B=e.textureProperties)||void 0===B?void 0:B._UvAnimMaskTexture,je=null!=Fe?{index:Fe,extensions:Object.assign({},oe)}:void 0,Ue=null===(D=e.floatProperties)||void 0===D?void 0:D._UvAnimScrollX;let We=null===(q=e.floatProperties)||void 0===q?void 0:q._UvAnimScrollY;null!=We&&(We=-We);const Le={specVersion:"1.0",transparentWithZWrite:I,renderQueueOffsetNumber:X,shadeColorFactor:ve,shadeMultiplyTexture:ce,shadingShiftFactor:fe,shadingToonyFactor:he,giEqualizationFactor:me,matcapFactor:xe,matcapTexture:Pe,rimLightingMixFactor:Te,rimMultiplyTexture:ge,parametricRimColorFactor:be,parametricRimFresnelPowerFactor:Oe,parametricRimLiftFactor:Ve,outlineWidthMode:Ce,outlineWidthFactor:ye,outlineWidthMultiplyTexture:Se,outlineColorFactor:we,outlineLightingMixFactor:Ee,uvAnimationMaskTexture:je,uvAnimationScrollXSpeedFactor:Ue,uvAnimationScrollYSpeedFactor:We,uvAnimationRotationSpeedFactor:null===(K=e.floatProperties)||void 0===K?void 0:K._UvAnimRotation};return Object.assign(Object.assign({},o),{pbrMetallicRoughness:{baseColorFactor:te,baseColorTexture:re},normalTexture:se,emissiveTexture:de,emissiveFactor:ae,alphaMode:G,alphaCutoff:J,doubleSided:ee,extensions:{VRMC_materials_mtoon:Le}})}_parseV0UnlitProperties(e,o){var t,i,r,l;const s="VRM/UnlitTransparentZWrite"===e.shader,a="VRM/UnlitTransparent"===e.shader||s,u=this._v0ParseRenderQueue(e),d="VRM/UnlitCutout"===e.shader,v=a?"BLEND":d?"MASK":"OPAQUE",p=d?null===(t=e.floatProperties)||void 0===t?void 0:t._Cutoff:void 0,c=this._portTextureTransform(e),f=null===(r=null===(i=e.vectorProperties)||void 0===i?void 0:i._Color)||void 0===r?void 0:r.map(n),h=null===(l=e.textureProperties)||void 0===l?void 0:l._MainTex,_=null!=h?{index:h,extensions:Object.assign({},c)}:void 0,m={specVersion:"1.0",transparentWithZWrite:s,renderQueueOffsetNumber:u,shadeColorFactor:f,shadeMultiplyTexture:_};return Object.assign(Object.assign({},o),{pbrMetallicRoughness:{baseColorFactor:f,baseColorTexture:_},alphaMode:v,alphaCutoff:p,extensions:{VRMC_materials_mtoon:m}})}_portTextureTransform(e){var o,t,i,r,n;const l=null===(o=e.vectorProperties)||void 0===o?void 0:o._MainTex;if(null==l)return{};const s=[null!==(t=null==l?void 0:l[0])&&void 0!==t?t:0,null!==(i=null==l?void 0:l[1])&&void 0!==i?i:0],a=[null!==(r=null==l?void 0:l[2])&&void 0!==r?r:1,null!==(n=null==l?void 0:l[3])&&void 0!==n?n:1];return s[1]=1-a[1]-s[1],{KHR_texture_transform:{offset:s,scale:a}}}_v0ParseRenderQueue(e){var o,t,i;const r=null!==(t=null===(o=e.keywordMap)||void 0===o?void 0:o._ALPHABLEND_ON)&&void 0!==t&&t,n=1===(null===(i=e.floatProperties)||void 0===i?void 0:i._ZWrite);let l=0;if(r){const o=e.renderQueue;null!=o&&(l=n?this._renderQueueMapTransparentZWrite.get(o):this._renderQueueMapTransparent.get(o))}return l}_populateRenderQueueMap(e){const o=new Set,t=new Set;e.forEach((e=>{var i,r,n;const l=null!==(r=null===(i=e.keywordMap)||void 0===i?void 0:i._ALPHABLEND_ON)&&void 0!==r&&r,s=1===(null===(n=e.floatProperties)||void 0===n?void 0:n._ZWrite);if(l){const i=e.renderQueue;null!=i&&(s?t.add(i):o.add(i))}})),o.size>10&&console.warn(`VRMMaterialsV0CompatPlugin: This VRM uses ${o.size} render queues for Transparent materials while VRM 1.0 only supports up to 10 render queues. The model might not be rendered correctly.`),t.size>10&&console.warn(`VRMMaterialsV0CompatPlugin: This VRM uses ${t.size} render queues for TransparentZWrite materials while VRM 1.0 only supports up to 10 render queues. The model might not be rendered correctly.`),Array.from(o).sort().forEach(((e,t)=>{const i=Math.min(Math.max(t-o.size+1,-9),0);this._renderQueueMapTransparent.set(e,i)})),Array.from(t).sort().forEach(((e,o)=>{const t=Math.min(Math.max(o,0),9);this._renderQueueMapTransparentZWrite.set(e,t)}))}},Object.defineProperty(e,"__esModule",{value:!0}),Object.assign(o,e)}));
