/*! (c) 2020-2024 pixiv Inc. - https://github.com/pixiv/three-vrm/blob/release/LICENSE */
!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).THREE_VRM_MATERIALS_V0COMPAT={},e.THREE)}(this,(function(e,o){"use strict";function t(e){if(e&&e.__esModule)return e;var o=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(o,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})}})),o.default=e,Object.freeze(o)}var i=t(o);function r(e,o,t,i){return new(t||(t=Promise))((function(r,n){function l(e){try{a(i.next(e))}catch(e){n(e)}}function s(e){try{a(i.throw(e))}catch(e){n(e)}}function a(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(l,s)}a((i=i.apply(e,o||[])).next())}))}function n(e){return Math.pow(e,2.2)}"function"==typeof SuppressedError&&SuppressedError;e.VRMMaterialsV0CompatPlugin=class{get name(){return"VRMMaterialsV0CompatPlugin"}constructor(e){var o;this.parser=e,this._renderQueueMapTransparent=new Map,this._renderQueueMapTransparentZWrite=new Map;const t=this.parser.json;t.extensionsUsed=null!==(o=t.extensionsUsed)&&void 0!==o?o:[],-1===t.extensionsUsed.indexOf("KHR_texture_transform")&&t.extensionsUsed.push("KHR_texture_transform")}beforeRoot(){var e;return r(this,void 0,void 0,(function*(){const o=this.parser.json,t=null===(e=o.extensions)||void 0===e?void 0:e.VRM,i=null==t?void 0:t.materialProperties;i&&(this._populateRenderQueueMap(i),i.forEach(((e,t)=>{var i,r;const n=null===(i=o.materials)||void 0===i?void 0:i[t];if(null!=n)if("VRM/MToon"===e.shader){const i=this._parseV0MToonProperties(e,n);o.materials[t]=i}else if(null===(r=e.shader)||void 0===r?void 0:r.startsWith("VRM/Unlit")){const i=this._parseV0UnlitProperties(e,n);o.materials[t]=i}else"VRM_USE_GLTFSHADER"===e.shader||console.warn(`VRMMaterialsV0CompatPlugin: Unknown shader: ${e.shader}`);else console.warn(`VRMMaterialsV0CompatPlugin: Attempt to use materials[${t}] of glTF but the material doesn't exist`)})))}))}_parseV0MToonProperties(e,o){var t,r,l,s,a,u,d,v,p,c,f,h,_,m,M,x,P,T,R,g,b,O,V,C,y,A,S,E,w,F,j,U,W,L,Q,N,H,Z,k,z,B,D,q,K,$,I,X,Y,G,J,ee,oe,te,ie,re;const ne=null!==(r=null===(t=e.keywordMap)||void 0===t?void 0:t._ALPHABLEND_ON)&&void 0!==r&&r,le=1===(null===(l=e.floatProperties)||void 0===l?void 0:l._ZWrite)&&ne,se=this._v0ParseRenderQueue(e),ae=null!==(a=null===(s=e.keywordMap)||void 0===s?void 0:s._ALPHATEST_ON)&&void 0!==a&&a,ue=ne?"BLEND":ae?"MASK":"OPAQUE",de=ae?null!==(d=null===(u=e.floatProperties)||void 0===u?void 0:u._Cutoff)&&void 0!==d?d:.5:void 0,ve=0===(null!==(p=null===(v=e.floatProperties)||void 0===v?void 0:v._CullMode)&&void 0!==p?p:2),pe=this._portTextureTransform(e),ce=(null!==(f=null===(c=e.vectorProperties)||void 0===c?void 0:c._Color)&&void 0!==f?f:[1,1,1,1]).map(((e,o)=>3===o?e:n(e))),fe=null===(h=e.textureProperties)||void 0===h?void 0:h._MainTex,he=null!=fe?{index:fe,extensions:Object.assign({},pe)}:void 0,_e=null!==(m=null===(_=e.floatProperties)||void 0===_?void 0:_._BumpScale)&&void 0!==m?m:1,me=null===(M=e.textureProperties)||void 0===M?void 0:M._BumpMap,Me=null!=me?{index:me,scale:_e,extensions:Object.assign({},pe)}:void 0,xe=(null!==(P=null===(x=e.vectorProperties)||void 0===x?void 0:x._EmissionColor)&&void 0!==P?P:[0,0,0,1]).map(n),Pe=null===(T=e.textureProperties)||void 0===T?void 0:T._EmissionMap,Te=null!=Pe?{index:Pe,extensions:Object.assign({},pe)}:void 0,Re=(null!==(g=null===(R=e.vectorProperties)||void 0===R?void 0:R._ShadeColor)&&void 0!==g?g:[.97,.81,.86,1]).map(n),ge=null===(b=e.textureProperties)||void 0===b?void 0:b._ShadeTexture,be=null!=ge?{index:ge,extensions:Object.assign({},pe)}:void 0;let Oe=null!==(V=null===(O=e.floatProperties)||void 0===O?void 0:O._ShadeShift)&&void 0!==V?V:0,Ve=null!==(y=null===(C=e.floatProperties)||void 0===C?void 0:C._ShadeToony)&&void 0!==y?y:.9;Ve=i.MathUtils.lerp(Ve,1,.5+.5*Oe),Oe=-Oe-(1-Ve);const Ce=null!==(S=null===(A=e.floatProperties)||void 0===A?void 0:A._IndirectLightIntensity)&&void 0!==S?S:.1,ye=Ce?1-Ce:void 0,Ae=null===(E=e.textureProperties)||void 0===E?void 0:E._SphereAdd,Se=null!=Ae?[1,1,1]:void 0,Ee=null!=Ae?{index:Ae}:void 0,we=null!==(F=null===(w=e.floatProperties)||void 0===w?void 0:w._RimLightingMix)&&void 0!==F?F:0,Fe=null===(j=e.textureProperties)||void 0===j?void 0:j._RimTexture,je=null!=Fe?{index:Fe,extensions:Object.assign({},pe)}:void 0,Ue=(null!==(W=null===(U=e.vectorProperties)||void 0===U?void 0:U._RimColor)&&void 0!==W?W:[0,0,0,1]).map(n),We=null!==(Q=null===(L=e.floatProperties)||void 0===L?void 0:L._RimFresnelPower)&&void 0!==Q?Q:1,Le=null!==(H=null===(N=e.floatProperties)||void 0===N?void 0:N._RimLift)&&void 0!==H?H:0,Qe=["none","worldCoordinates","screenCoordinates"][null!==(k=null===(Z=e.floatProperties)||void 0===Z?void 0:Z._OutlineWidthMode)&&void 0!==k?k:0];let Ne=null!==(B=null===(z=e.floatProperties)||void 0===z?void 0:z._OutlineWidth)&&void 0!==B?B:0;Ne*=.01;const He=null===(D=e.textureProperties)||void 0===D?void 0:D._OutlineWidthTexture,Ze=null!=He?{index:He,extensions:Object.assign({},pe)}:void 0,ke=(null!==(K=null===(q=e.vectorProperties)||void 0===q?void 0:q._OutlineColor)&&void 0!==K?K:[0,0,0]).map(n),ze=1===(null!==(I=null===($=e.floatProperties)||void 0===$?void 0:$._OutlineColorMode)&&void 0!==I?I:0)?null!==(Y=null===(X=e.floatProperties)||void 0===X?void 0:X._OutlineLightingMix)&&void 0!==Y?Y:1:0,Be=null===(G=e.textureProperties)||void 0===G?void 0:G._UvAnimMaskTexture,De=null!=Be?{index:Be,extensions:Object.assign({},pe)}:void 0,qe=null!==(ee=null===(J=e.floatProperties)||void 0===J?void 0:J._UvAnimScrollX)&&void 0!==ee?ee:0;let Ke=null!==(te=null===(oe=e.floatProperties)||void 0===oe?void 0:oe._UvAnimScrollY)&&void 0!==te?te:0;null!=Ke&&(Ke=-Ke);const $e={specVersion:"1.0",transparentWithZWrite:le,renderQueueOffsetNumber:se,shadeColorFactor:Re,shadeMultiplyTexture:be,shadingShiftFactor:Oe,shadingToonyFactor:Ve,giEqualizationFactor:ye,matcapFactor:Se,matcapTexture:Ee,rimLightingMixFactor:we,rimMultiplyTexture:je,parametricRimColorFactor:Ue,parametricRimFresnelPowerFactor:We,parametricRimLiftFactor:Le,outlineWidthMode:Qe,outlineWidthFactor:Ne,outlineWidthMultiplyTexture:Ze,outlineColorFactor:ke,outlineLightingMixFactor:ze,uvAnimationMaskTexture:De,uvAnimationScrollXSpeedFactor:qe,uvAnimationScrollYSpeedFactor:Ke,uvAnimationRotationSpeedFactor:null!==(re=null===(ie=e.floatProperties)||void 0===ie?void 0:ie._UvAnimRotation)&&void 0!==re?re:0};return Object.assign(Object.assign({},o),{pbrMetallicRoughness:{baseColorFactor:ce,baseColorTexture:he},normalTexture:Me,emissiveTexture:Te,emissiveFactor:xe,alphaMode:ue,alphaCutoff:de,doubleSided:ve,extensions:{VRMC_materials_mtoon:$e}})}_parseV0UnlitProperties(e,o){var t,i,r,l,s;const a="VRM/UnlitTransparentZWrite"===e.shader,u="VRM/UnlitTransparent"===e.shader||a,d=this._v0ParseRenderQueue(e),v="VRM/UnlitCutout"===e.shader,p=u?"BLEND":v?"MASK":"OPAQUE",c=v?null!==(i=null===(t=e.floatProperties)||void 0===t?void 0:t._Cutoff)&&void 0!==i?i:.5:void 0,f=this._portTextureTransform(e),h=(null!==(l=null===(r=e.vectorProperties)||void 0===r?void 0:r._Color)&&void 0!==l?l:[1,1,1,1]).map(n),_=null===(s=e.textureProperties)||void 0===s?void 0:s._MainTex,m=null!=_?{index:_,extensions:Object.assign({},f)}:void 0,M={specVersion:"1.0",transparentWithZWrite:a,renderQueueOffsetNumber:d,shadeColorFactor:h,shadeMultiplyTexture:m};return Object.assign(Object.assign({},o),{pbrMetallicRoughness:{baseColorFactor:h,baseColorTexture:m},alphaMode:p,alphaCutoff:c,extensions:{VRMC_materials_mtoon:M}})}_portTextureTransform(e){var o,t,i,r,n;const l=null===(o=e.vectorProperties)||void 0===o?void 0:o._MainTex;if(null==l)return{};const s=[null!==(t=null==l?void 0:l[0])&&void 0!==t?t:0,null!==(i=null==l?void 0:l[1])&&void 0!==i?i:0],a=[null!==(r=null==l?void 0:l[2])&&void 0!==r?r:1,null!==(n=null==l?void 0:l[3])&&void 0!==n?n:1];return s[1]=1-a[1]-s[1],{KHR_texture_transform:{offset:s,scale:a}}}_v0ParseRenderQueue(e){var o,t,i;const r=null!==(t=null===(o=e.keywordMap)||void 0===o?void 0:o._ALPHABLEND_ON)&&void 0!==t&&t,n=1===(null===(i=e.floatProperties)||void 0===i?void 0:i._ZWrite);let l=0;if(r){const o=e.renderQueue;null!=o&&(l=n?this._renderQueueMapTransparentZWrite.get(o):this._renderQueueMapTransparent.get(o))}return l}_populateRenderQueueMap(e){const o=new Set,t=new Set;e.forEach((e=>{var i,r,n;const l=null!==(r=null===(i=e.keywordMap)||void 0===i?void 0:i._ALPHABLEND_ON)&&void 0!==r&&r,s=1===(null===(n=e.floatProperties)||void 0===n?void 0:n._ZWrite);if(l){const i=e.renderQueue;null!=i&&(s?t.add(i):o.add(i))}})),o.size>10&&console.warn(`VRMMaterialsV0CompatPlugin: This VRM uses ${o.size} render queues for Transparent materials while VRM 1.0 only supports up to 10 render queues. The model might not be rendered correctly.`),t.size>10&&console.warn(`VRMMaterialsV0CompatPlugin: This VRM uses ${t.size} render queues for TransparentZWrite materials while VRM 1.0 only supports up to 10 render queues. The model might not be rendered correctly.`),Array.from(o).sort().forEach(((e,t)=>{const i=Math.min(Math.max(t-o.size+1,-9),0);this._renderQueueMapTransparent.set(e,i)})),Array.from(t).sort().forEach(((e,o)=>{const t=Math.min(Math.max(o,0),9);this._renderQueueMapTransparentZWrite.set(e,t)}))}},Object.defineProperty(e,"__esModule",{value:!0}),Object.assign(o,e)}));
