/*! (c) 2019-2024 pixiv Inc. - https://github.com/pixiv/three-vrm/blob/release/LICENSE */
var un=Object.defineProperty,ln=Object.defineProperties;var cn=Object.getOwnPropertyDescriptors;var Ue=Object.getOwnPropertySymbols;var dn=Object.prototype.hasOwnProperty,pn=Object.prototype.propertyIsEnumerable;var Ge=(l,e,n)=>e in l?un(l,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[e]=n,d=(l,e)=>{for(var n in e||(e={}))dn.call(e,n)&&Ge(l,n,e[n]);if(Ue)for(var n of Ue(e))pn.call(e,n)&&Ge(l,n,e[n]);return l},b=(l,e)=>ln(l,cn(e));var Ze=(l,e,n)=>new Promise((t,s)=>{var o=r=>{try{i(n.next(r))}catch(u){s(u)}},a=r=>{try{i(n.throw(r))}catch(u){s(u)}},i=r=>r.done?t(r.value):Promise.resolve(r.value).then(o,a);i((n=n.apply(l,e)).next())});import*as Ie from"three";function M(l){return Math.pow(l,2.2)}var g=class{get name(){return"VRMMaterialsV0CompatPlugin"}constructor(e){var t;this.parser=e,this._renderQueueMapTransparent=new Map,this._renderQueueMapTransparentZWrite=new Map;let n=this.parser.json;n.extensionsUsed=(t=n.extensionsUsed)!=null?t:[],n.extensionsUsed.indexOf("KHR_texture_transform")===-1&&n.extensionsUsed.push("KHR_texture_transform")}beforeRoot(){return Ze(this,null,function*(){var s;let e=this.parser.json,n=(s=e.extensions)==null?void 0:s.VRM,t=n==null?void 0:n.materialProperties;t&&(this._populateRenderQueueMap(t),t.forEach((o,a)=>{var r,u;let i=(r=e.materials)==null?void 0:r[a];if(i==null){console.warn(`VRMMaterialsV0CompatPlugin: Attempt to use materials[${a}] of glTF but the material doesn't exist`);return}if(o.shader==="VRM/MToon"){let c=this._parseV0MToonProperties(o,i);e.materials[a]=c}else if((u=o.shader)!=null&&u.startsWith("VRM/Unlit")){let c=this._parseV0UnlitProperties(o,i);e.materials[a]=c}else o.shader==="VRM_USE_GLTFSHADER"||console.warn(`VRMMaterialsV0CompatPlugin: Unknown shader: ${o.shader}`)}))})}_parseV0MToonProperties(e,n){var w,O,U,G,Z,I,P,N,H,k,B,D,j,z,q,K,$,X,Y,J,ee,ne,te,oe,re,se,ae,ie,ue,le,ce,de,pe,Me,fe,he,Te,xe,_e,me,Re,Ve,Fe,Ce,Le,Se,be,ge,ve,We,ye,Ae,Ee,Qe,we;let t=(O=(w=e.keywordMap)==null?void 0:w._ALPHABLEND_ON)!=null?O:!1,o=((U=e.floatProperties)==null?void 0:U._ZWrite)===1&&t,a=this._v0ParseRenderQueue(e),i=(Z=(G=e.keywordMap)==null?void 0:G._ALPHATEST_ON)!=null?Z:!1,r=t?"BLEND":i?"MASK":"OPAQUE",u=i?(P=(I=e.floatProperties)==null?void 0:I._Cutoff)!=null?P:.5:void 0,T=((H=(N=e.floatProperties)==null?void 0:N._CullMode)!=null?H:2)===0,p=this._portTextureTransform(e),C=((B=(k=e.vectorProperties)==null?void 0:k._Color)!=null?B:[1,1,1,1]).map((Oe,an)=>an===3?Oe:M(Oe)),f=(D=e.textureProperties)==null?void 0:D._MainTex,x=f!=null?{index:f,extensions:d({},p)}:void 0,_=(z=(j=e.floatProperties)==null?void 0:j._BumpScale)!=null?z:1,h=(q=e.textureProperties)==null?void 0:q._BumpMap,m=h!=null?{index:h,scale:_,extensions:d({},p)}:void 0,Pe=(($=(K=e.vectorProperties)==null?void 0:K._EmissionColor)!=null?$:[0,0,0,1]).map(M),v=(X=e.textureProperties)==null?void 0:X._EmissionMap,Ne=v!=null?{index:v,extensions:d({},p)}:void 0,He=((J=(Y=e.vectorProperties)==null?void 0:Y._ShadeColor)!=null?J:[.97,.81,.86,1]).map(M),W=(ee=e.textureProperties)==null?void 0:ee._ShadeTexture,ke=W!=null?{index:W,extensions:d({},p)}:void 0,R=(te=(ne=e.floatProperties)==null?void 0:ne._ShadeShift)!=null?te:0,V=(re=(oe=e.floatProperties)==null?void 0:oe._ShadeToony)!=null?re:.9;V=Ie.MathUtils.lerp(V,1,.5+.5*R),R=-R-(1-V);let y=(ae=(se=e.floatProperties)==null?void 0:se._IndirectLightIntensity)!=null?ae:.1,Be=y?1-y:void 0,L=(ie=e.textureProperties)==null?void 0:ie._SphereAdd,De=L!=null?[1,1,1]:void 0,je=L!=null?{index:L}:void 0,ze=(le=(ue=e.floatProperties)==null?void 0:ue._RimLightingMix)!=null?le:0,A=(ce=e.textureProperties)==null?void 0:ce._RimTexture,qe=A!=null?{index:A,extensions:d({},p)}:void 0,Ke=((pe=(de=e.vectorProperties)==null?void 0:de._RimColor)!=null?pe:[0,0,0,1]).map(M),$e=(fe=(Me=e.floatProperties)==null?void 0:Me._RimFresnelPower)!=null?fe:1,Xe=(Te=(he=e.floatProperties)==null?void 0:he._RimLift)!=null?Te:0,Ye=["none","worldCoordinates","screenCoordinates"][(_e=(xe=e.floatProperties)==null?void 0:xe._OutlineWidthMode)!=null?_e:0],S=(Re=(me=e.floatProperties)==null?void 0:me._OutlineWidth)!=null?Re:0;S=.01*S;let E=(Ve=e.textureProperties)==null?void 0:Ve._OutlineWidthTexture,Je=E!=null?{index:E,extensions:d({},p)}:void 0,en=((Ce=(Fe=e.vectorProperties)==null?void 0:Fe._OutlineColor)!=null?Ce:[0,0,0]).map(M),nn=((Se=(Le=e.floatProperties)==null?void 0:Le._OutlineColorMode)!=null?Se:0)===1?(ge=(be=e.floatProperties)==null?void 0:be._OutlineLightingMix)!=null?ge:1:0,Q=(ve=e.textureProperties)==null?void 0:ve._UvAnimMaskTexture,tn=Q!=null?{index:Q,extensions:d({},p)}:void 0,on=(ye=(We=e.floatProperties)==null?void 0:We._UvAnimScrollX)!=null?ye:0,F=(Ee=(Ae=e.floatProperties)==null?void 0:Ae._UvAnimScrollY)!=null?Ee:0;F!=null&&(F=-F);let rn=(we=(Qe=e.floatProperties)==null?void 0:Qe._UvAnimRotation)!=null?we:0,sn={specVersion:"1.0",transparentWithZWrite:o,renderQueueOffsetNumber:a,shadeColorFactor:He,shadeMultiplyTexture:ke,shadingShiftFactor:R,shadingToonyFactor:V,giEqualizationFactor:Be,matcapFactor:De,matcapTexture:je,rimLightingMixFactor:ze,rimMultiplyTexture:qe,parametricRimColorFactor:Ke,parametricRimFresnelPowerFactor:$e,parametricRimLiftFactor:Xe,outlineWidthMode:Ye,outlineWidthFactor:S,outlineWidthMultiplyTexture:Je,outlineColorFactor:en,outlineLightingMixFactor:nn,uvAnimationMaskTexture:tn,uvAnimationScrollXSpeedFactor:on,uvAnimationScrollYSpeedFactor:F,uvAnimationRotationSpeedFactor:rn};return b(d({},n),{pbrMetallicRoughness:{baseColorFactor:C,baseColorTexture:x},normalTexture:m,emissiveTexture:Ne,emissiveFactor:Pe,alphaMode:r,alphaCutoff:u,doubleSided:T,extensions:{VRMC_materials_mtoon:sn}})}_parseV0UnlitProperties(e,n){var f,x,_,h,m;let t=e.shader==="VRM/UnlitTransparentZWrite",s=e.shader==="VRM/UnlitTransparent"||t,o=this._v0ParseRenderQueue(e),a=e.shader==="VRM/UnlitCutout",i=s?"BLEND":a?"MASK":"OPAQUE",r=a?(x=(f=e.floatProperties)==null?void 0:f._Cutoff)!=null?x:.5:void 0,u=this._portTextureTransform(e),c=((h=(_=e.vectorProperties)==null?void 0:_._Color)!=null?h:[1,1,1,1]).map(M),T=(m=e.textureProperties)==null?void 0:m._MainTex,p=T!=null?{index:T,extensions:d({},u)}:void 0,C={specVersion:"1.0",transparentWithZWrite:t,renderQueueOffsetNumber:o,shadeColorFactor:c,shadeMultiplyTexture:p};return b(d({},n),{pbrMetallicRoughness:{baseColorFactor:c,baseColorTexture:p},alphaMode:i,alphaCutoff:r,extensions:{VRMC_materials_mtoon:C}})}_portTextureTransform(e){var o,a,i,r,u;let n=(o=e.vectorProperties)==null?void 0:o._MainTex;if(n==null)return{};let t=[(a=n==null?void 0:n[0])!=null?a:0,(i=n==null?void 0:n[1])!=null?i:0],s=[(r=n==null?void 0:n[2])!=null?r:1,(u=n==null?void 0:n[3])!=null?u:1];return t[1]=1-s[1]-t[1],{KHR_texture_transform:{offset:t,scale:s}}}_v0ParseRenderQueue(e){var o,a,i;let n=(a=(o=e.keywordMap)==null?void 0:o._ALPHABLEND_ON)!=null?a:!1,t=((i=e.floatProperties)==null?void 0:i._ZWrite)===1,s=0;if(n){let r=e.renderQueue;r!=null&&(t?s=this._renderQueueMapTransparentZWrite.get(r):s=this._renderQueueMapTransparent.get(r))}return s}_populateRenderQueueMap(e){let n=new Set,t=new Set;e.forEach(s=>{var i,r,u;let o=(r=(i=s.keywordMap)==null?void 0:i._ALPHABLEND_ON)!=null?r:!1,a=((u=s.floatProperties)==null?void 0:u._ZWrite)===1;if(o){let c=s.renderQueue;c!=null&&(a?t.add(c):n.add(c))}}),n.size>10&&console.warn(`VRMMaterialsV0CompatPlugin: This VRM uses ${n.size} render queues for Transparent materials while VRM 1.0 only supports up to 10 render queues. The model might not be rendered correctly.`),t.size>10&&console.warn(`VRMMaterialsV0CompatPlugin: This VRM uses ${t.size} render queues for TransparentZWrite materials while VRM 1.0 only supports up to 10 render queues. The model might not be rendered correctly.`),Array.from(n).sort().forEach((s,o)=>{let a=Math.min(Math.max(o-n.size+1,-9),0);this._renderQueueMapTransparent.set(s,a)}),Array.from(t).sort().forEach((s,o)=>{let a=Math.min(Math.max(o,0),9);this._renderQueueMapTransparentZWrite.set(s,a)})}};export{g as VRMMaterialsV0CompatPlugin};
